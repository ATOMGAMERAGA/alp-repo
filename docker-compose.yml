version: '3.8'

services:
  alp:
    build:
      context: .
      dockerfile: Dockerfile
      # BuildKit for faster builds and better caching
      cache_from:
        - alp-manager:latest
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: alp-manager:latest
    container_name: alp-package-manager
    
    # Volume mount - persistent data (optimized mounts)
    volumes:
      - alp-data:/root/.alp
      - alp-packages:/root/.alp/installed
      - alp-cache:/root/.alp/cache:cached  # Cached for better performance
      - alp-logs:/root/.alp/logs:delegated  # Delegated for better write performance
    
    # Environment variables - Optimized
    environment:
      - TZ=Europe/Istanbul
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - ALP_AUTO_UPDATE=true
      - PIP_NO_CACHE_DIR=1
    
    # Resource limits for better performance
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 128M
    
    # Restart policy
    restart: unless-stopped
    
    # stdin açık tut (interaktif mod için)
    stdin_open: true
    tty: true
    
    # Network
    networks:
      - alp-network

# Volumes tanımları (kalıcı veri)
volumes:
  alp-data:
    driver: local
  alp-packages:
    driver: local
  alp-cache:
    driver: local
  alp-logs:
    driver: local

# Network tanımı
networks:
  alp-network:
    driver: bridge
